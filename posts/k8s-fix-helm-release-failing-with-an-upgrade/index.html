<!doctype html><html lang=en-us><head><title>K8s: Fix Helm release failing with an upgrade still in progress // Cloudy Caffeine with Ana</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ana Cozma"><meta name=description content><link rel=stylesheet href=/blog/css/main.min.6f2f62cb3c0554c34e5ed3fe97d24c3ed198bb966ae12fb4c950f4d9326686d9.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-PD4F67ZWJD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PD4F67ZWJD",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="K8s: Fix Helm release failing with an upgrade still in progress"><meta name=twitter:description content="This article applies to: Helm v3.8.0
Helm helps you manage Kubernetes applications — Helm Charts help you define, install, and upgrade even the most complex Kubernetes application. More details on Helm and the commands can be found in the official documentation.
Assuming you use Helm to handle your releases, you might end up in a case where the release will be stuck in a pending state and all subsequent releases will keep failing."><meta property="og:title" content="K8s: Fix Helm release failing with an upgrade still in progress"><meta property="og:description" content="This article applies to: Helm v3.8.0
Helm helps you manage Kubernetes applications — Helm Charts help you define, install, and upgrade even the most complex Kubernetes application. More details on Helm and the commands can be found in the official documentation.
Assuming you use Helm to handle your releases, you might end up in a case where the release will be stuck in a pending state and all subsequent releases will keep failing."><meta property="og:type" content="article"><meta property="og:url" content="https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-30T17:49:48+01:00"><meta property="article:modified_time" content="2022-05-30T17:49:48+01:00"></head><body><header class=app-header><a href=https://ana-cozma.github.io/blog><img class=app-header-avatar src=/blog/avatar.jpg alt="Ana Cozma"></a>
<span class=app-header-title>Cloudy Caffeine with Ana</span><nav class=app-header-menu><a class=app-header-menu-item href=/blog/>Home</a>
|
<a class=app-header-menu-item href=/blog/tags/>Tags</a>
|
<a class=app-header-menu-item href=/blog/coffee/>Coffee</a>
|
<a class=app-header-menu-item href=/blog/about/>About</a></nav><p>A blog about cloud, tech and coffee</p><div class=app-header-social><a href=https://github.com/ana-cozma target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/the_cozma target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://www.linkedin.com/in/ana-cozma/ target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>LinkedIn</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>K8s: Fix Helm release failing with an upgrade still in progress</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>May 30, 2022</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 min read</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://ana-cozma.github.io/blog/tags/kubernetes/>kubernetes</a>
<a class=tag href=https://ana-cozma.github.io/blog/tags/helm/>helm</a></div></div></header><div class=post-content><p>This article applies to: <strong>Helm v3.8.0</strong></p><blockquote><p><em>Helm helps you manage Kubernetes applications — Helm Charts help you define, install, and upgrade even the most complex Kubernetes application. More details on Helm and the commands can be found in the <a href=https://helm.sh/>official documentation</a>.</em></p></blockquote><p>Assuming you use Helm to handle your releases, you might end up in a case where the release will be stuck in a pending state and all subsequent releases will keep failing.</p><p>This could happen if:</p><ul><li>you run the upgrade command from the cli and accidentally (or not) interrupt it or</li><li>you have two deploys running at the same time (maybe in Github Actions, for example)</li></ul><p>Basically, any interruption that occurred during your install/upgrade process <strong>could</strong> lead you to a state where you cannot install another release anymore.</p><p>In the release logs the failing upgrade will show an error similar to the following:</p><pre tabindex=0><code>Error: UPGRADE FAILED: release &lt;name&gt; failed, and has been rolled back due to atomic being set: timed out waiting for the condition
Error: Error: The process &#39;/usr/bin/helm3&#39; failed with exit code 1
Error: The process &#39;/usr/bin/helm3&#39; failed with exit code 1
</code></pre><p>And the status will be stuck in: <code>PENDING_INSTALL</code> or <code>PENDING_UPGRADE</code> depending on the command you were running.</p><p>Because of this pending state when you run the command to list all release it will return empty:</p><pre tabindex=0><code>&gt; helm list --all                                                                               
NAME	NAMESPACE	REVISION	UPDATED	STATUS	CHART	APP VERSION
</code></pre><p>So what can we do now? In this article we will look over the two options described below. Keep in mind that based on your setup it could be another issue, but I&rsquo;m hoping that these two pointers will give you a place to start.</p><ol><li>Roll back to the previous working version using the <code>helm rollback</code> command.</li><li>Delete the helm secret associated with the release and re-run the upgrade command.</li></ol><p>So let&rsquo;s look at each option in detail.</p><h3 id=first-option-roll-back-to-the-previous-working-version-using-the-helm-rollback-command>First option: Roll back to the previous working version using the <code>helm rollback</code> command</h3><p>From the official documentation:</p><blockquote><p><em>This command rolls back a release to a previous revision.
The first argument of the rollback command is the name of a release, and the second is a revision (version) number. If this argument is omitted, it will roll back to the previous release.</em></p></blockquote><p>So, in this case, let&rsquo;s get the history of the releases:</p><pre tabindex=0><code>helm history &lt;releasename&gt; -n &lt;namespace&gt;
</code></pre><p>In the output you will notice the STATUS of your release with: <code>pending-upgrade</code>:</p><pre tabindex=0><code>REVISION UPDATED                  STATUS          CHART     APP VERSION DESCRIPTION
1        Wed May 25 11:45:40 2022 DEPLOYED        api-0.1.0 1.16.0      Upgrade complete
2        Mon May 30 14:32:46 2022 PENDING_UPGRADE api-0.1.0 1.16.0      Preparing upgrade
</code></pre><p>Now let&rsquo;s perform the rollback by running the following command:</p><pre tabindex=0><code>helm rollback &lt;release&gt; &lt;revision&gt; --namespace &lt;namespace&gt;
</code></pre><p>So in our case we run:</p><pre tabindex=0><code>&gt; helm rollback api 1 --namespace api
Rollback was a success.
</code></pre><p>After we get confirmation that the rollback was successful, we run the command to get the history again.</p><p>We now see we have two releases and that our rollback was successful having the STATUS is: <code>deployed</code></p><pre tabindex=0><code>&gt; helm history api -n api

REVISION UPDATED                  STATUS      CHART     APP VERSION DESCRIPTION
1        Wed May 25 11:45:40 2022 SUPERSEEDED api-0.1.0 1.16.0      Upgrade complete
2        Mon May 30 14:32:46 2022 SUPERSEEDED api-0.1.0 1.16.0      Preparing upgrade
3        Mon May 30 14:45:46 2022 DEPLOYED    api-0.1.0 1.16.0      Rollback to 1
</code></pre><p>So what if the solution above didn&rsquo;t work?</p><h3 id=second-option-delete-the-helm-secret-associated-with-the-release-and-re-run-the-upgrade-command>Second option: Delete the helm secret associated with the release and re-run the upgrade command</h3><p>First we get all the secrets for the namespace by running:</p><pre tabindex=0><code>kubectl get secrets -n &lt;namespace&gt;
</code></pre><p>In the output you will notice a list of secrets in the following format:</p><pre tabindex=0><code>NAME                        TYPE               DATA AGE
api                         Opaque             21   473d
sh.helm.release.v1.api.v648 helm.sh/release.v1 1    6d5h
sh.helm.release.v1.api.v649 helm.sh/release.v1 1    5d1h
sh.helm.release.v1.api.v650 helm.sh/release.v1 1    57m
</code></pre><p><strong>So what&rsquo;s in a secret?</strong></p><p>Helm3 makes use of the Kubernetes <a href=https://kubernetes.io/docs/concepts/configuration/secret/>Secrets</a> object to store any information regarding a release. These secrets are basically used by Helm to store and read it&rsquo;s state every time we run: <code>helm list</code>, <code>helm history</code> or <code>helm upgrade</code> in our case.</p><p>The naming of the secrets is <strong>unique per namespace</strong>.
The format follows the following convention:
<code>sh.helm.release.v1.&lt;release_name>.&lt;release_version></code>.</p><p>There is a max of 10 secrets that are stored by default, but you can modify this by setting the <code>--history-max</code> flag in your <a href=https://helm.sh/docs/helm/helm_upgrade/>helm upgrade</a> command.</p><blockquote><p><em>&ndash;history-max int limit the maximum number of revisions saved per release. Use 0 for no limit (default 10)</em></p></blockquote><p>Now that we know what these secrets are used for, let&rsquo;s delete the helm secret associated with the pending release by running the following command:</p><pre tabindex=0><code>kubectl delete secret sh.helm.release.v1.&lt;release_name&gt;.v&lt;release_version&gt; -n &lt;namespace&gt;
</code></pre><p>Finally, we re-run the helm upgrade command (either from command line or from your deployment workflow), which, if all was good so far, should succeed.</p><p>There is an open issue with <a href=https://github.com/helm/helm/issues/4558>Helm</a> so hopefully these workaround won&rsquo;t be needed anymore. But it&rsquo;s open since 2018.</p><p><em>Of course there could be other cases or issues, but I hope this is a nice place to start. If you ran into something similar I would love to read your input in what the issue was and how you solved it especially since I didn&rsquo;t find the error message to be intuitive.</em></p><p><em>Thank you for reading!</em></p></div><div class=post-footer><style>.resp-sharing-button__link,.resp-sharing-button__icon{display:inline-block}.resp-sharing-button__link{text-decoration:none;color:#fff!important;margin:.2em}.resp-sharing-button{border-radius:5px;transition:25ms ease-out;padding:.5em .75em;font-family:Helvetica Neue,Helvetica,Arial,sans-serif}.resp-sharing-button__icon svg{width:1em;height:1em;margin-right:.4em;vertical-align:middle}.resp-sharing-button--small svg{margin:0;vertical-align:middle}.resp-sharing-button__icon{stroke:#fff;fill:none}.resp-sharing-button__icon--solid,.resp-sharing-button__icon--solidcircle{fill:#fff;stroke:none}.resp-sharing-button--twitter{background-color:#55acee}.resp-sharing-button--twitter:hover{background-color:#2795e9}.resp-sharing-button--pinterest{background-color:#bd081c}.resp-sharing-button--pinterest:hover{background-color:#8c0615}.resp-sharing-button--facebook{background-color:#3b5998}.resp-sharing-button--facebook:hover{background-color:#2d4373}.resp-sharing-button--tumblr{background-color:#35465c}.resp-sharing-button--tumblr:hover{background-color:#222d3c}.resp-sharing-button--reddit{background-color:#ff4500}.resp-sharing-button--reddit:hover{background-color:#3a80c1}.resp-sharing-button--google{background-color:#dd4b39}.resp-sharing-button--google:hover{background-color:#c23321}.resp-sharing-button--linkedin{background-color:#0077b5}.resp-sharing-button--linkedin:hover{background-color:#046293}.resp-sharing-button--email{background-color:#777}.resp-sharing-button--email:hover{background-color:#5e5e5e}.resp-sharing-button--xing{background-color:#1a7576}.resp-sharing-button--xing:hover{background-color:#114c4c}.resp-sharing-button--whatsapp{background-color:#25d366}.resp-sharing-button--whatsapp:hover{background-color:#1da851}.resp-sharing-button--hackernews{background-color:#f60}.resp-sharing-button--hackernews:hover,.resp-sharing-button--hackernews:focus{background-color:#fb6200}.resp-sharing-button--vk{background-color:#507299}.resp-sharing-button--vk:hover{background-color:#43648c}.resp-sharing-button--facebook{background-color:#3b5998;border-color:#3b5998}.resp-sharing-button--facebook:hover,.resp-sharing-button--facebook:active{background-color:#2d4373;border-color:#2d4373}.resp-sharing-button--twitter{background-color:#55acee;border-color:#55acee}.resp-sharing-button--twitter:hover,.resp-sharing-button--twitter:active{background-color:#2795e9;border-color:#2795e9}.resp-sharing-button--tumblr{background-color:#35465c;border-color:#35465c}.resp-sharing-button--tumblr:hover,.resp-sharing-button--tumblr:active{background-color:#222d3c;border-color:#222d3c}.resp-sharing-button--email{background-color:#777;border-color:#777}.resp-sharing-button--email:hover,.resp-sharing-button--email:active{background-color:#5e5e5e;border-color:#5e5e5e}.resp-sharing-button--pinterest{background-color:#bd081c;border-color:#bd081c}.resp-sharing-button--pinterest:hover,.resp-sharing-button--pinterest:active{background-color:#8c0615;border-color:#8c0615}.resp-sharing-button--linkedin{background-color:#0077b5;border-color:#0077b5}.resp-sharing-button--linkedin:hover,.resp-sharing-button--linkedin:active{background-color:#046293;border-color:#046293}.resp-sharing-button--reddit{background-color:#ff4500;border-color:#ff4500}.resp-sharing-button--reddit:hover,.resp-sharing-button--reddit:active{background-color:#ff5700;border-color:#ff5700}.resp-sharing-button--xing{background-color:#1a7576;border-color:#1a7576}.resp-sharing-button--xing:hover .resp-sharing-button--xing:active{background-color:#114c4c;border-color:#114c4c}.resp-sharing-button--whatsapp{background-color:#25d366;border-color:#25d366}.resp-sharing-button--whatsapp:hover,.resp-sharing-button--whatsapp:active{background-color:#1da851;border-color:#1da851}.resp-sharing-button--hackernews{background-color:#f60;border-color:#f60}.resp-sharing-button--hackernews:hover .resp-sharing-button--hackernews:active{background-color:#fb6200;border-color:#fb6200}.resp-sharing-button--vk{background-color:#507299;border-color:#507299}.resp-sharing-button--vk:hover .resp-sharing-button--vk:active{background-color:#43648c;border-color:#43648c}.resp-sharing-button--telegram{background-color:#54a9eb}.resp-sharing-button--telegram:hover{background-color:#4b97d1}</style><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/" target=_blank rel=noopener aria-label title=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=K8s%3a%20Fix%20Helm%20release%20failing%20with%20an%20upgrade%20still%20in%20progress&amp;url=https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/" target=_blank rel=noopener aria-label title=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/&amp;title=K8s%3a%20Fix%20Helm%20release%20failing%20with%20an%20upgrade%20still%20in%20progress&amp;summary=K8s%3a%20Fix%20Helm%20release%20failing%20with%20an%20upgrade%20still%20in%20progress&amp;https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6.0 2.5 1 2.6 2.5.0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https://ana-cozma.github.io/blog/posts/k8s-fix-helm-release-failing-with-an-upgrade/&amp;resubmit=true&amp;title=K8s%3a%20Fix%20Helm%20release%20failing%20with%20an%20upgrade%20still%20in%20progress" target=_blank rel=noopener aria-label title=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><script src=https://giscus.app/client.js data-repo=ana-cozma/blog data-repo-id=586287035 data-category="Post Comments" data-category-id=DIC_kwDOIvGqC84CTeD0 data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark_dimmed data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main></body></html>